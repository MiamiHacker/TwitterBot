<% locals.document.forEach( document =>{ %>

    <br><br>
    <div class="postPreview" id="div_<%= document.publicID %>">
                
        <div id="profilePopup_<%= document.poster %>" class="userPopupContainer">
            <div id="profilePopup_<%= document.poster %>" class="profilePopup">
                <img id="profileImg_<%= document.poster %>" src="calltodb">
                <a href="/users/<%= document.poster %>"><%= document.poster %></a>
                <button id="followBtn_<%= document.poster %>" class="followBtn <%= locals.authRequired %> calltobdforStatus">follow</button>
                <a id="following_<%= document.poster %>" href="/users/<%= document.poster %>">Loading</a>
                <a id="followers_<%= document.poster %>" href="/users/<%= document.poster %>">Loading</a>
            </div>
    
            <h3> <a href="/users/<%= document.poster %>"> <%= document.poster %> </a></h3>
        </div>

        <h1> <%= document.content %> </h1>
        <h1> - <%= document.quoteAuthor %> </h1>

        <% document.tags.forEach( tag =>{ %>
            <a href="/results?search_query=<%= tag %>">#<%= tag %>&nbsp</a>
        <% }) %>   

        <br>
        <a href=<%= '/posts/'+ document.publicID %>> <%= document.comments.length %> comments </a>
    
        
        <!-- delete/favorite button -->
        <% if(locals.userInfo.username === document.poster){ %>
            <button class="deleteButton" id="delete_<%= document.publicID %>">Delete</button>
        <% }else{ %>
            <% if(document.favoritedBy.includes(locals.userInfo.username)){ %>
                <button class="favoriteButton favorited" id="favorite_<%= document.publicID %>">♥ favorite</button>
            <% }else{ %>
                <button class="favoriteButton <%= locals.authRequired %>" id="favorite_<%= document.publicID %>">♥ favorite</button>
            <% } %>
        <% } %>

    </div>

<% }) %>

<style>
    .favorited{
        border: red 2px solid;
    }

    .postPreview{
        border: solid black 2px;
    }

    .userPopupContainer:hover div{
        display: block;
    }

    .userPopupContainer{
        border: solid rgb(0, 255, 0) 2px;
        position: relative;
        width:fit-content;
    }
    .userPopupContainer h3{
        margin: 0;
    }

    .profilePopup{
        border: solid blue 2px;
        display: none;
        
        position: absolute;
        z-index: 5;
        
        bottom: 100%;
        left: -0.5em;

        height: 5.5em;
        width: 25em;

        background-color: aliceblue;
    }

    img{
        width: 5em;
    }
</style>

<% if(locals.userInfo.isLoggedIn){ %>
<script>
(()=>{//favoriteButton
    let favoriteButtonCollection = document.getElementsByClassName('favoriteButton');
    let array = [];
    // console.log(favoriteButton[8])
    
    for (let index = 0; index < favoriteButtonCollection.length; index++) {
        array[index] = favoriteButtonCollection[index];
    }   

    array.forEach( button =>{
        button.addEventListener('click', async ()=>{
            let fetcher = await (await fetch('/users/favorite/'+button.id.slice(9),{method:'post'})).json();
            if(fetcher.action === 'removed'){
                button.className = 'favoriteButton'; // remove favorited class
            }
            if(fetcher.action === 'added'){
                button.className = 'favoriteButton favorited'; // add favorited class
            }
        });
    });


//deletePostButton
    let deleteButtonCollection = document.getElementsByClassName('deleteButton');
    let deleteArray = [];

    for (let index = 0; index < deleteButtonCollection.length; index++) {
        deleteArray[index] = deleteButtonCollection[index];
    }

    deleteArray.forEach(deleteButton => {
        deleteButton.addEventListener('click', async()=>{

            let fetcher = await (await fetch('/posts/delete/'+deleteButton.id.slice(7),{method:'POST'})).json();
            if(fetcher.action === 'deleted'){
                let deleteDiv = document.getElementById('div_'+deleteButton.id.slice(7));
                // delete the postsPreview.ejs from DOM 
                deleteDiv.innerHTML = '<h2> Post deleted successfully</h2>'
            }
            else{
                // it should never get to this path if the user does not mess with http request
                // just as precaution: redirect = GET/all
                window.location.href = "/all";
            }
        });
    });

})();
</script>
<% } %>

<script>
(()=>{
//profilePopup
    // profilePopup_
    // profileImg_
    // followBtn_
    // following_
    // followers_
    let userPopupCollection = document.getElementsByClassName('userPopupContainer');

    for (let index = 0; index < userPopupCollection.length; index++) {
        userPopupCollection[index].addEventListener('mouseover',async()=>{
            let username = userPopupCollection[index].id.slice(13);
            let fetcher = await (await fetch('/users/popup/'+username)).json();

            console.log(fetcher);

            // console.log((document.getElementById('followBtn_'+username).className)+' smhtnelse');
            document.getElementById('profileImg_'+username).src  = 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png'
        });
        
    }

})();

</script>